<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPP Calculator</title>
    <meta name="theme-color" content="#374151">
    <link rel="manifest" href="manifest.json">
    
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 400 700;
            font-display: swap;
            src: local('Inter'), local('Inter-Regular');
        }
    </style>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: #0f172a; min-height: 100vh; }
        .header { background: #374151; color: white; padding: 18px 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 20px; font-weight: 700; }
        .header p { font-size: 13px; opacity: 0.7; margin-top: 6px; }
        .main { padding: 20px; max-width: 500px; margin: 0 auto; }
        .steps { display: flex; justify-content: center; gap: 60px; margin-bottom: 24px; position: relative; }
        .steps::before { content: ''; position: absolute; top: 15px; left: 30%; right: 30%; height: 2px; background: #e2e8f0; }
        .step { display: flex; flex-direction: column; align-items: center; gap: 6px; z-index: 1; cursor: pointer; }
        .step-num { width: 32px; height: 32px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; color: #94a3b8; }
        .step.active .step-num { background: #10b981; color: white; }
        .step.done .step-num { background: #0f172a; color: white; }
        .step-label { font-size: 10px; color: #64748b; }
        .step.active .step-label { color: #10b981; font-weight: 600; }
        .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .card-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .card-title svg { width: 20px; height: 20px; color: #10b981; }
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .input-group { flex: 1; }
        .input-group label { display: block; font-size: 11px; color: #64748b; margin-bottom: 6px; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #94a3b8; border-radius: 10px; font-size: 14px; font-family: inherit; background: white; }
        .input-group input:focus { outline: none; border-color: #10b981; }
        .input-group.small { max-width: 70px; }
        .input-group.medium { max-width: 100px; }
        .product-list { margin-top: 16px; }
        .product-item { padding: 12px; background: #f8fafc; border-radius: 10px; margin-bottom: 8px; }
        .product-header { display: flex; justify-content: space-between; align-items: center; }
        .product-item .name { font-weight: 500; font-size: 14px; }
        .product-item .cost { font-size: 11px; color: #64748b; margin-top: 4px; }
        .product-item .margin-info { font-size: 11px; color: #10b981; margin-top: 2px; }
        .product-actions { display: flex; gap: 6px; }
        .product-item .edit { width: 28px; height: 28px; border: none; background: #dbeafe; color: #3b82f6; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .product-item .delete { width: 28px; height: 28px; border: none; background: #fee2e2; color: #ef4444; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-secondary { background: #e2e8f0; color: #0f172a; margin-bottom: 10px; }
        .btn-warning { background: #fbbf24; color: #0f172a; margin-bottom: 10px; }
        .result-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .result-table th { text-align: left; padding: 8px 4px; background: #f1f5f9; font-weight: 600; font-size: 9px; color: #64748b; }
        .result-table td { padding: 8px 4px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        .result-table .price { font-weight: 700; color: #10b981; }
        .result-table .semi { font-weight: 700; color: #3b82f6; }
        .result-table .grosir { font-weight: 700; color: #0f172a; }
        .result-table .edit { width: 32px; height: 24px; border: none; background: #dbeafe; color: #3b82f6; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .result-table .delete { width: 24px; height: 24px; border: none; background: #fee2e2; color: #ef4444; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 6px; }
        .section { display: none; }
        .section.active { display: block; }
        .nav-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .nav-buttons .btn { flex: 1; }
        .divider { height: 1px; background: #e2e8f0; margin: 16px 0; }
        .section-label { font-size: 11px; color: #64748b; margin-bottom: 10px; font-weight: 500; }
        .hint { font-size: 10px; color: #94a3b8; font-style: italic; margin-top: 8px; }
        .info-bar { background: #0f172a; color: white; padding: 10px 16px; display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 16px; border-radius: 10px; }
        .info-bar .item { text-align: center; }
        .info-bar .item label { opacity: 0.7; font-size: 10px; display: block; }
        .info-bar .item .val { font-weight: 600; color: #10b981; }
        @media (min-width: 768px) { body { max-width: 500px; margin: 0 auto; box-shadow: 0 0 40px rgba(0,0,0,0.1); } }
    </style>
</head>
<body>
    <header class="header">
        <h1>HPP Calculator</h1>
        <p>Kalkulator Harga Pokok & Margin</p>
    </header>
    
    <div id="headerInfoBar" style="padding:16px 20px;">
        <div style="display:flex;justify-content:center;gap:12px;text-align:center;max-width:500px;margin:0 auto;">
            <div style="flex:1;background:white;border-radius:10px;padding:12px 8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border:1px solid #e2e8f0;"><div style="font-size:10px;color:#64748b;">Total Produk</div><div style="font-size:18px;font-weight:700;color:#ef4444;" id="headerProduk">0</div></div>
            <div style="flex:1;background:white;border-radius:10px;padding:12px 8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border:1px solid #e2e8f0;"><div style="font-size:10px;color:#64748b;">Total Pcs</div><div style="font-size:18px;font-weight:700;color:#ef4444;" id="headerPcs">0</div></div>
            <div style="flex:1;background:white;border-radius:10px;padding:12px 8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border:1px solid #e2e8f0;"><div style="font-size:10px;color:#64748b;">Total Belanja</div><div style="font-size:18px;font-weight:700;color:#ef4444;" id="headerBelanja">-</div></div>
        </div>
    </div>
    
    <main class="main">
        
        
        <!-- STEP 1: Input Produk -->
        <div class="section active" id="step1">

            
            <div class="card">
                <div class="card-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                    <span id="formTitle">Tambah Produk</span>
                </div>
                
                <input type="hidden" id="editIndex" value="-1">
                
                <div class="input-row">
                    <div class="input-group"><label>Nama Produk</label><input type="text" id="produkNama" placeholder="Nama Produk" style="font-size:12px;"></div>
                </div>
                
                <div class="input-row">
                    <div class="input-group medium"><label>Satuan Beli</label><input type="text" id="satuanBeli" placeholder=""></div>
                    <div class="input-group small"><label>Jumlah</label><input type="number" id="jumlahBeli" placeholder="1" min="1"></div>
                    <div class="input-group"><label>Harga/Satuan (Rp)</label><input type="text" id="hargaSatuan" placeholder="" oninput="formatInputNumber(this)"></div>
                </div>
                
                <div class="input-row">
                    <div class="input-group small"><label>Isi Kemasan</label><input type="number" id="isiPak" value="" min="0"></div>
                    <div class="input-group small"><label>Isi Satuan</label><input type="number" id="isiPcs" value="" min="0"></div>
                    <div class="input-group"><label>Var Cost (Rp)</label><input type="text" id="varCost" value="" oninput="formatInputNumber(this)"></div>
                </div>
                <p class="hint">Isi Kemasan = slop/renceng per bal/dus. Isi Satuan = pcs per kemasan. Kosongkan jika tidak ada.</p>
                
                <div class="divider"></div>
                
                <div class="section-label">Target Margin (%)</div>
                <div class="input-row">
                    <div class="input-group"><label>Retail</label><input type="number" id="marginRetail" value="" step="0.1" min="0" max="200"></div>
                    <div class="input-group"><label>Grosir</label><input type="number" id="marginGrosir" value="" step="0.1" min="0" max="200"></div>
                    <div class="input-group"><label>Partai</label><input type="number" id="marginPartai" value="" step="0.1" min="0" max="200"></div>
                </div>
                
                <div style="display:flex;gap:10px;margin-top:16px;">
                    <button id="btnSimpan" onclick="saveProduct()" style="flex:1;display:flex;align-items:center;justify-content:center;gap:8px;background:none;border:none;color:#0f172a;font-weight:600;font-size:14px;cursor:pointer;font-family:inherit;padding:14px;border-radius:12px;"><svg width="20" height="20" viewBox="0 0 16 16" fill="none"><path d="M15 16H1V9H3V14H13V9H15V16Z" fill="#0f172a"/><path d="M12 6H9V0H7V6H4V7L8 11L12 7V6Z" fill="#0f172a"/></svg> Tambah Produk</button>
                    <button onclick="goToStep(2)" style="flex:1;display:flex;align-items:center;justify-content:center;gap:8px;background:none;border:none;color:#10b981;font-weight:600;font-size:14px;cursor:pointer;font-family:inherit;">Review <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M11 16L15 12M15 12L11 8M15 12H3M11 3H17.8C18.92 3 19.48 3 19.908 3.218C20.284 3.41 20.59 3.716 20.782 4.092C21 4.52 21 5.08 21 6.2V17.8C21 18.92 21 19.48 20.782 19.908C20.59 20.284 20.284 20.59 19.908 20.782C19.48 21 18.92 21 17.8 21H11" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                </div>
                <button class="btn btn-warning" id="btnBatal" onclick="cancelEdit()" style="display:none;">Batal Edit</button>
                
                <div class="product-list" id="productList"></div>
            </div>
        </div>
        
        <!-- STEP 2: Review / Hasil -->
        <div class="section" id="step2">

            
            <div id="avgMarginBox" style="margin-bottom:16px;">
                <div style="font-size:12px;font-weight:600;color:#065f46;margin-bottom:12px;text-align:center;">Rata-rata Margin (Perkiraan Untung Kotor)</div>
                <div style="display:flex;justify-content:center;gap:12px;text-align:center;">
                    <div style="flex:1;background:white;border-radius:10px;padding:12px 8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border:1px solid #94a3b8;"><div style="font-size:10px;color:#64748b;">Retail</div><div style="font-size:18px;font-weight:700;color:#10b981;" id="avgRetail">0%</div></div>
                    <div style="flex:1;background:white;border-radius:10px;padding:12px 8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border:1px solid #94a3b8;"><div style="font-size:10px;color:#64748b;">Grosir</div><div style="font-size:18px;font-weight:700;color:#3b82f6;" id="avgGrosir">0%</div></div>
                    <div style="flex:1;background:white;border-radius:10px;padding:12px 8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border:1px solid #94a3b8;"><div style="font-size:10px;color:#64748b;">Partai</div><div style="font-size:18px;font-weight:700;color:#0f172a;" id="avgPartai">0%</div></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Hasil Perhitungan
                </div>
                <div id="reviewTableContainer"></div>
                

            </div>
            
            <div class="nav-buttons" style="justify-content:space-between;">
                <button onclick="goToStep(1)" style="display:flex;align-items:center;justify-content:center;gap:8px;background:none;border:none;color:#10b981;font-weight:600;font-size:14px;cursor:pointer;font-family:inherit;padding:14px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 8L9 12M9 12L13 16M9 12H21M13 21H6.2C5.08 21 4.52 21 4.092 20.782C3.716 20.59 3.41 20.284 3.218 19.908C3 19.48 3 18.92 3 17.8V6.2C3 5.08 3 4.52 3.218 4.092C3.41 3.716 3.716 3.41 4.092 3.218C4.52 3 5.08 3 6.2 3H13" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Kembali</button>
                <button onclick="saveToFile()" style="display:flex;align-items:center;justify-content:center;gap:8px;background:none;border:none;color:#0f172a;font-weight:600;font-size:14px;cursor:pointer;font-family:inherit;padding:14px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3ZM12 19C10.34 19 9 17.66 9 16C9 14.34 10.34 13 12 13C13.66 13 15 14.34 15 16C15 17.66 13.66 19 12 19ZM15 9H5V5H15V9Z" fill="#0f172a"/></svg> Save</button>
            </div>
        </div>
    </main>
    
    <script>
        let products = [];
        
        function loadData() {
            const saved = localStorage.getItem('hpp_products');
            if (saved) products = JSON.parse(saved);
        }
        
        function saveData() {
            localStorage.setItem('hpp_products', JSON.stringify(products));
        }
        
        function parseNumber(str) { return parseInt(String(str).replace(/\./g, '').replace(/[^0-9]/g, '')) || 0; }
        function formatInputNumber(input) {
            let value = input.value.replace(/\./g, '').replace(/[^0-9]/g, '');
            if (value) input.value = parseInt(value).toLocaleString('id-ID');
        }
        function formatRupiah(num) { return 'Rp ' + num.toLocaleString('id-ID'); }
        
        function getTotalPcs() { return products.reduce((sum, p) => sum + p.totalPcs, 0); }
        function getTotalHarga() { return products.reduce((sum, p) => sum + (p.harga * p.jumlah), 0); }
        
        function updateInfoBar() {
            const totalHarga = getTotalHarga();
            const totalPcs = getTotalPcs();
            
            if (products.length > 0) {
                document.getElementById('headerProduk').textContent = products.length;
                document.getElementById('headerPcs').textContent = totalPcs.toLocaleString('id-ID');
                document.getElementById('headerBelanja').textContent = formatRupiah(totalHarga);
            }
        }
        
        function saveProduct() {
            const editIndex = parseInt(document.getElementById('editIndex').value);
            const nama = document.getElementById('produkNama').value.trim();
            const satuan = document.getElementById('satuanBeli').value.trim() || 'Unit';
            const jumlah = parseInt(document.getElementById('jumlahBeli').value) || 1;
            const harga = parseNumber(document.getElementById('hargaSatuan').value);
            const isiPak = parseInt(document.getElementById('isiPak').value) || 0;
            const isiPcs = parseInt(document.getElementById('isiPcs').value) || 0;
            const varCost = parseNumber(document.getElementById('varCost').value);
            const marginRetail = parseFloat(document.getElementById('marginRetail').value) || 0;
            const marginGrosir = parseFloat(document.getElementById('marginGrosir').value) || 0;
            const marginPartai = parseFloat(document.getElementById('marginPartai').value) || 0;
            
            if (!nama) { alert('Mohon isi nama produk'); return; }
            if (!harga) { alert('Mohon isi harga beli'); return; }
            
            let totalPcs, hargaPerPcs, levels;
            
            if (isiPak > 0 && isiPcs > 0) {
                totalPcs = jumlah * isiPak * isiPcs;
                hargaPerPcs = harga / isiPak / isiPcs;
                levels = 3;
            } else if (isiPak > 0) {
                totalPcs = jumlah * isiPak;
                hargaPerPcs = harga / isiPak;
                levels = 2;
            } else {
                totalPcs = jumlah;
                hargaPerPcs = harga;
                levels = 1;
            }
            
            const productData = {
                nama, satuan, jumlah, harga, isiPak, isiPcs, varCost,
                marginRetail, marginGrosir, marginPartai,
                totalPcs, hargaPerPcs, levels
            };
            
            if (editIndex >= 0) {
                products[editIndex] = productData;
            } else {
                products.push(productData);
            }
            
            clearForm();
            renderProducts();
            saveData();
        }
        
        function clearForm() {
            document.getElementById('editIndex').value = '-1';
            document.getElementById('formTitle').textContent = 'Tambah Produk';
            document.getElementById('btnSimpan').innerHTML = '<svg width="20" height="20" viewBox="0 0 16 16" fill="none"><path d="M15 16H1V9H3V14H13V9H15V16Z" fill="#0f172a"/><path d="M12 6H9V0H7V6H4V7L8 11L12 7V6Z" fill="#0f172a"/></svg> Tambah Produk';
            document.getElementById('btnBatal').style.display = 'none';
            document.getElementById('produkNama').value = '';
            document.getElementById('satuanBeli').value = '';
            document.getElementById('jumlahBeli').value = '';
            document.getElementById('hargaSatuan').value = '';
            document.getElementById('isiPak').value = '';
            document.getElementById('isiPcs').value = '';
            document.getElementById('varCost').value = '';
            document.getElementById('marginRetail').value = '';
            document.getElementById('marginGrosir').value = '';
            document.getElementById('marginPartai').value = '';
        }
        
        function editProduct(index) {
            const p = products[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('formTitle').textContent = 'Edit Produk';
            document.getElementById('btnSimpan').innerHTML = '<svg width="20" height="20" viewBox="0 0 16 16" fill="none"><path d="M15 16H1V9H3V14H13V9H15V16Z" fill="#0f172a"/><path d="M12 6H9V0H7V6H4V7L8 11L12 7V6Z" fill="#0f172a"/></svg> Simpan Perubahan';
            document.getElementById('btnBatal').style.display = 'block';
            document.getElementById('produkNama').value = p.nama;
            document.getElementById('satuanBeli').value = p.satuan;
            document.getElementById('jumlahBeli').value = p.jumlah;
            document.getElementById('hargaSatuan').value = p.harga.toLocaleString('id-ID');
            document.getElementById('isiPak').value = p.isiPak || '';
            document.getElementById('isiPcs').value = p.isiPcs || '';
            document.getElementById('varCost').value = p.varCost ? p.varCost.toLocaleString('id-ID') : '';
            document.getElementById('marginRetail').value = p.marginRetail;
            document.getElementById('marginGrosir').value = p.marginGrosir;
            document.getElementById('marginPartai').value = p.marginPartai;
            window.scrollTo(0, 0);
        }
        
        function cancelEdit() { clearForm(); }
        
        function removeProduct(index) {
            if (confirm('Hapus produk ini?')) {
                products.splice(index, 1);
                renderProducts();
                saveData();
            }
        }
        
        function renderProducts() {
            const list = document.getElementById('productList');
            if (products.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#94a3b8;font-size:13px;padding:20px;">Belum ada produk</p>';
            } else {
                const lastThree = products.slice(-3);
                const startIndex = products.length - lastThree.length;
                let html = '';
                if (products.length > 3) {
                    html = `<p style="text-align:center;color:#64748b;font-size:11px;margin-bottom:8px;">+${products.length - 3} produk lainnya (lihat di Review)</p>`;
                }
                html += lastThree.map((p, i) => {
                    const realIndex = startIndex + i;
                    let struktur = `${p.jumlah} ${p.satuan}`;
                    if (p.levels >= 2) struktur += ` x ${p.isiPak}`;
                    if (p.levels === 3) struktur += ` x ${p.isiPcs}`;
                    struktur += ` = ${p.totalPcs.toLocaleString('id-ID')} pcs`;
                    
                    let marginText = `R:${p.marginRetail}%`;
                    if (p.levels >= 2) marginText += ` G:${p.marginGrosir}% P:${p.marginPartai}%`;
                    
                    return `<div class="product-item">
                        <div class="product-header">
                            <div class="name">${p.nama}</div>
                            <div class="product-actions">
                                <button class="edit" onclick="editProduct(${realIndex})">Edit</button>
                                <button class="delete" onclick="removeProduct(${realIndex})">x</button>
                            </div>
                        </div>
                        <div class="cost">${struktur} | ${formatRupiah(p.harga)}/${p.satuan}</div>
                        <div class="margin-info">${marginText}</div>
                    </div>`;
                }).join('');
                list.innerHTML = html;
            }
            updateInfoBar();
        }
        
        function renderReviewTable() {
            const container = document.getElementById('reviewTableContainer');
            if (products.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#94a3b8;font-size:13px;padding:20px;">Belum ada produk</p>';
                return;
            }
            
            const results = products.map((p, i) => {
                const varPerPcs = p.totalPcs > 0 ? p.varCost / p.totalPcs : 0;
                const hppPerPcs = Math.round(p.hargaPerPcs + varPerPcs);
                
                let hargaRetail = null, hargaGrosir = null, hargaPartai = null;
                let labelRetail = '', labelGrosir = '', labelPartai = '';
                
                if (p.levels === 3) {
                    hargaRetail = Math.round(hppPerPcs * (1 + p.marginRetail / 100));
                    labelRetail = '/pcs';
                    const hppPerPak = hppPerPcs * p.isiPcs;
                    hargaGrosir = Math.round(hppPerPak * (1 + p.marginGrosir / 100));
                    labelGrosir = `/${p.isiPcs}pcs`;
                    const hppPerSatuan = hppPerPcs * p.isiPcs * p.isiPak;
                    hargaPartai = Math.round(hppPerSatuan * (1 + p.marginPartai / 100));
                    labelPartai = `/${p.satuan}`;
                } else if (p.levels === 2) {
                    hargaRetail = Math.round(hppPerPcs * (1 + p.marginRetail / 100));
                    labelRetail = '/pcs';
                    const hppPerPak = hppPerPcs * p.isiPak;
                    hargaGrosir = Math.round(hppPerPak * (1 + p.marginGrosir / 100));
                    labelGrosir = `/${p.isiPak}pcs`;
                    hargaPartai = Math.round(hppPerPak * (1 + p.marginPartai / 100));
                    labelPartai = `/${p.satuan}`;
                } else {
                    hargaRetail = Math.round(hppPerPcs * (1 + p.marginRetail / 100));
                    labelRetail = `/${p.satuan}`;
                }
                
                return { ...p, index: i, hppPerPcs, hargaRetail, hargaGrosir, hargaPartai, labelRetail, labelGrosir, labelPartai };
            });
            
            let html = `<table class="result-table">
                <thead><tr><th>Produk</th><th>HPP/pcs</th><th>Retail</th><th>Grosir</th><th>Partai</th><th></th></tr></thead>
                <tbody>`;
            
            results.forEach(r => {
                const retailCell = r.hargaRetail 
                    ? `<span class="price">${r.hargaRetail.toLocaleString('id-ID')}</span><br><span style="font-size:9px;color:#64748b;">${r.labelRetail}</span>` 
                    : '-';
                const grosirCell = r.hargaGrosir 
                    ? `<span class="semi">${r.hargaGrosir.toLocaleString('id-ID')}</span><br><span style="font-size:9px;color:#64748b;">${r.labelGrosir}</span>` 
                    : '-';
                const partaiCell = r.hargaPartai 
                    ? `<span class="grosir">${r.hargaPartai.toLocaleString('id-ID')}</span><br><span style="font-size:9px;color:#64748b;">${r.labelPartai}</span>` 
                    : '-';
                
                html += `<tr>
                    <td><strong>${r.nama}</strong></td>
                    <td>${r.hppPerPcs.toLocaleString('id-ID')}</td>
                    <td>${retailCell}</td>
                    <td>${grosirCell}</td>
                    <td>${partaiCell}</td>
                    <td><div style="display:flex;gap:6px;"><button class="edit" onclick="editProductFromReview(${r.index})">Edit</button><button class="delete" onclick="deleteProductFromReview(${r.index})">x</button></div></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function editProductFromReview(index) {
            goToStep(1);
            setTimeout(() => editProduct(index), 100);
        }
        
        function deleteProductFromReview(index) {
            if (confirm('Hapus produk ini?')) {
                products.splice(index, 1);
                saveData();
                renderReviewTable();
                updateInfoBar();
                if (products.length === 0) goToStep(1);
            }
        }
        
        function goToStep(step) {
            if (step >= 2 && products.length === 0) { alert('Tambahkan minimal 1 produk'); return; }
            if (step === 2) { renderReviewTable(); calculateAvgMargin(); }
            
            updateInfoBar();
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'done');
                if (i + 1 < step) s.classList.add('done');
                if (i + 1 === step) s.classList.add('active');
            });
        }
        
        function calculateAvgMargin() {
            if (products.length === 0) return;
            
            let totalNilai = 0;
            let sumRetail = 0, sumGrosir = 0, sumPartai = 0;
            
            products.forEach(p => {
                const nilai = p.harga * p.jumlah;
                totalNilai += nilai;
                sumRetail += nilai * p.marginRetail;
                sumGrosir += nilai * p.marginGrosir;
                sumPartai += nilai * p.marginPartai;
            });
            
            const avgRetail = totalNilai > 0 ? (sumRetail / totalNilai).toFixed(1) : 0;
            const avgGrosir = totalNilai > 0 ? (sumGrosir / totalNilai).toFixed(1) : 0;
            const avgPartai = totalNilai > 0 ? (sumPartai / totalNilai).toFixed(1) : 0;
            
            document.getElementById('avgRetail').textContent = avgRetail + '%';
            document.getElementById('avgGrosir').textContent = avgGrosir + '%';
            document.getElementById('avgPartai').textContent = avgPartai + '%';
        }
        
        function saveToFile() {
            if (products.length === 0) { alert('Tidak ada data untuk disimpan'); return; }
            const date = new Date().toLocaleDateString('id-ID');
            let text = `HPP Calculator - ${date}\n${'='.repeat(40)}\n\n`;
            text += `Total Produk: ${products.length}\n`;
            text += `Total Pcs: ${getTotalPcs().toLocaleString('id-ID')}\n`;
            text += `Total Belanja: ${formatRupiah(getTotalHarga())}\n\n`;
            text += `${'='.repeat(40)}\nDETAIL PRODUK\n${'='.repeat(40)}\n\n`;
            products.forEach((p, i) => {
                const varPerPcs = p.totalPcs > 0 ? p.varCost / p.totalPcs : 0;
                const hppPerPcs = Math.round(p.hargaPerPcs + varPerPcs);
                let hargaRetail = Math.round(hppPerPcs * (1 + p.marginRetail / 100));
                let hargaGrosir = '-', hargaPartai = '-';
                if (p.levels === 3) {
                    hargaGrosir = Math.round(hppPerPcs * p.isiPcs * (1 + p.marginGrosir / 100));
                    hargaPartai = Math.round(hppPerPcs * p.isiPcs * p.isiPak * (1 + p.marginPartai / 100));
                } else if (p.levels === 2) {
                    hargaGrosir = Math.round(hppPerPcs * p.isiPak * (1 + p.marginGrosir / 100));
                    hargaPartai = Math.round(hppPerPcs * p.isiPak * (1 + p.marginPartai / 100));
                }
                text += `${i+1}. ${p.nama}\n`;
                text += `   HPP/pcs: Rp ${hppPerPcs.toLocaleString('id-ID')}\n`;
                text += `   Harga Retail: Rp ${hargaRetail.toLocaleString('id-ID')}\n`;
                text += `   Harga Grosir: ${typeof hargaGrosir === 'number' ? 'Rp ' + hargaGrosir.toLocaleString('id-ID') : hargaGrosir}\n`;
                text += `   Harga Partai: ${typeof hargaPartai === 'number' ? 'Rp ' + hargaPartai.toLocaleString('id-ID') : hargaPartai}\n\n`;
            });
            const blob = new Blob([text], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `hpp_${date.replace(/\//g, '-')}.txt`;
            a.click();
        }
        
        // Initialize
        loadData();
        renderProducts();
        
        // Enter key to save product
        document.querySelectorAll('#step1 input').forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveProduct();
            });
        });
        
        // Register Service Worker for offline
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('SW registered'))
                .catch(() => console.log('SW failed'));
        }
    </script>
    <footer style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size:9px;color:#94a3b8;text-align:center;padding:16px;background:#e2e8f0;border-top:1px solid #cbd5e1;">HPP CALC Â©2026 by AMINDRA</footer>
</body>
</html>
